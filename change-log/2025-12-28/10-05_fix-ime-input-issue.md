# 日本語入力時のIME確定問題の修正

## 何を (What)

Markdownエディタで日本語入力時にIMEが勝手に確定されてしまう問題を修正しました。具体的には、「テスト」と入力したいのに「ｔｔえうお」のように入力・確定される現象を解決しました。

**変更されたファイル:**
- `src/features/editor/presentation/components/markdown-editor/markdown-editor.tsx`
- `docs/fix/markdown-editor/hook-dependencies.md` (新規追加)

## どんな目的で (Why)

日本語入力時にIMEが途中で確定されてしまう問題は、ユーザー体験を大きく損なう重大なバグでした。この問題により、ユーザーは正常に日本語を入力することができず、エディタの実用性が著しく低下していました。

根本的な原因は、Reactの`useEffect`フックの依存配列に頻繁に変化する値（`activeTab?.content`）が含まれていたことです。これにより、ユーザーが1文字入力するたびにエディタのコンテンツが更新され、コンポーネントが再レンダリングされ、IMEの状態がリセットされていました。

## どう変更したか (How)

### 1. useEffectの依存配列から`activeTab?.content`を削除

`useEffect`の依存配列から`activeTab?.content`を削除し、`activeTab?.id`のみに依存するように変更しました。これにより、タブの内容が更新されても、エディタのコンテンツ読み込み処理が再実行されなくなりました。

### 2. タブ切り替え検知機能の追加

前回読み込んだタブIDを`useRef`で保持し、タブが切り替わった時のみコンテンツを読み込むようにしました。これにより、同じタブで入力している間は不要な再レンダリングが発生しなくなりました。

### 3. コンテンツ比較による更新制御

タブが切り替わっていない場合、現在のエディタの内容とタブの内容を比較し、同じ場合は更新処理をスキップするようにしました。これにより、IME入力中の不要な`replaceBlocks`実行を防止しました。

### 4. ドキュメントの追加

Tiptap/ProseMirror系エディタでよくあるIME入力問題の原因と解決策をまとめたドキュメントを追加しました。主な原因として以下を説明しています：

- `useEditor`の依存配列に頻繁に変わる値が含まれている
- コンポーネントの定義場所が不適切
- 親コンポーネントからの`content`プロップスの渡しすぎ

## 考えられる影響と範囲

### ユーザーエクスペリエンスへの影響

- **改善**: 日本語入力が正常に動作するようになり、ユーザーはストレスなく日本語を入力できるようになりました
- **影響範囲**: Markdownエディタを使用するすべてのユーザーに影響します

### パフォーマンスへの影響

- **改善**: 不要な再レンダリングが削減され、エディタのパフォーマンスが向上しました
- **影響範囲**: エディタコンポーネントのレンダリング処理に限定されます

### 既存機能への影響

- **影響なし**: タブの切り替えやコンテンツの保存機能は従来通り動作します
- **改善**: タブ切り替え時のコンテンツ読み込みがより確実になりました

## 課題

現時点で特に課題はありません。ただし、将来的に以下の点を検討する余地があります：

- 他のエディタコンポーネントでも同様の問題が発生していないか確認
- エディタのパフォーマンス監視と最適化の継続的な改善

