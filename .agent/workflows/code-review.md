---
type: command
name: code-review
description: PR作成前に、変更内容を分析してコードレビューツールが指摘しそうな問題を検出し、優先度別チェックリストを生成。実装・既存実装との比較・テスト・ドキュメントの4観点から分析します。
tools: Git, Grep, Codebase Search, Read, Write
model: inherit
---

# コードレビュー事前チェックリスト生成

PR作成前に、変更内容を分析してコードレビューで指摘されそうな問題を事前に検出し、優先度別のチェックリストを生成します。

## 前提

- まずリポジトリルートで実行
- ステージ済みの変更がある場合、それらを優先して分析

## 実行手順

### 1. 変更内容の把握

#### ステージ済み変更の確認

```
git status --porcelain=v1 -uall
git diff --staged --name-only
git diff --staged --stat
git diff --staged -U0
```

#### PRメッセージまたは変更内容ファイルの確認

- 指定されたファイル（例：`pr_message_body.md`）がある場合は内容を読み込む
- 実装内容、追加されたエンドポイント/コンポーネント、変更の意図を理解

### 2. 既存実装パターンの抽出

以下のパターンを検索して、既存の実装スタイルを把握します：

#### エラーハンドリングパターン

- 統一されたエラーレスポンス生成関数の検索
- エラー表示コンポーネントの検索
- エラーハンドリングユーティリティの検索

#### 認証・認可パターン

- 認証デコレータ、ミドルウェア、ガードの検索
- 高階コンポーネント（HOC）、ProtectedRouteなどの検索
- 認証ヘルパー関数の検索

#### データ取得パターン

- API呼び出しパターンの検索（フック、サービス関数など）
- データフェッチングの統一パターン
- サービス層、リポジトリパターンの検索

#### 状態管理パターン

- グローバル状態管理ライブラリの使用パターン
- ローカル状態管理パターン
- カスタムフック、状態管理ヘルパーの検索

#### UIコンポーネントパターン

- 共通コンポーネントの検索
- レイアウトコンポーネントの検索
- デザインシステムの使用パターン
- コンポーネント命名規則の確認

#### APIレスポンス形式

- 統一されたレスポンス形式の確認
- エラーレスポンス形式の確認
- データ構造の一貫性チェック

#### 型定義

- TypeScriptの型定義パターン
- 型ヒントの使用パターン
- 型安全性の確保方法

### 3. 4つの観点から分析

#### 実装

- コード品質：可読性、保守性、パフォーマンス
- 設計パターン：適切なパターンの使用、アンチパターンの回避
- ベストプラクティス：言語・フレームワークの推奨事項に準拠
- セキュリティ：入力検証、認証・認可の実装

#### 既存実装との比較・統一性

- **命名規則**: 変数名、関数名、コンポーネント名、APIエンドポイント名の一貫性
- **エラーハンドリング**: 既存パターンとの整合性
- **アーキテクチャパターン**: レイヤー分離、関心の分離、責任の明確化
- **コンポーネント設計**: プレゼンテーション/コンテナ分離、カスタムフックの活用
- **API設計**: エンドポイント構造、リクエスト/レスポンス形式の統一性

#### テスト

- テストカバレッジの充足度
- テストの品質：正常系・異常系・エッジケースのカバー
- テストパターンの一貫性
- モック・スタブの適切な使用
- 統合テスト・E2Eテストの存在

#### ドキュメント

- 仕様書との整合性
- 実装とドキュメントの不一致
- ドキュメントの更新漏れ
- コメント、docstringの詳細度
- APIドキュメント、コンポーネントドキュメントの不足

### 4. 問題の検出と優先度分類

検出した問題を以下のカテゴリに分類します：

#### 🔴 重大な問題（修正必須）

- 命名規則の不整合（APIヘッダー名、変数名、関数名、コンポーネント名など）
- セキュリティ上の問題（ハードコードされた認証情報、入力検証不足、XSS/CSRFリスクなど）
- 動作に影響する実装の不統一（API仕様の不一致、コンポーネントインターフェースの不一致など）
- 破壊的変更の可能性
- 型安全性の問題（TypeScriptの型エラー、ランタイムエラーのリスクなど）

#### 🟡 中程度の問題（修正推奨）

- エラーハンドリングパターンの不統一
- アーキテクチャパターンの違反（レイヤー分離の違反、関心の分離の不足など）
- コードの重複（バリデーションロジック、ビジネスロジック、UIロジックなど）
- 共通ユーティリティやヘルパー関数の未使用
- 状態管理パターンの不統一（グローバル状態、ローカル状態の使い分けなど）
- コンポーネント設計の不統一（プレゼンテーション/コンテナ分離、カスタムフックの活用など）

#### 🟢 軽微な問題（改善推奨）

- ログレベルの統一
- ドキュメント文字列の詳細度
- バリデーションロジックの重複
- コードスタイルの統一
- UI/UXの一貫性（デザインシステムの使用、アクセシビリティ属性など）

#### テスト関連

- テストカバレッジの不足
- エラーレスポンス形式の検証不足
- 統合テストの不足
- エッジケースのテスト不足
- UIコンポーネントのテスト不足（スナップショットテスト、インタラクションテストなど）
- E2Eテストの不足

#### ドキュメント関連

- 仕様書との整合性
- 実装とドキュメントの不一致
- ドキュメントの更新漏れ
- コンポーネントのProps/APIドキュメントの不足

#### セキュリティ関連

- 認証情報のハードコーディング
- エラーメッセージの情報漏洩リスク
- 入力検証の不足
- XSS/CSRF対策の不足
- 機密情報のクライアントサイド露出

#### パフォーマンス関連

- 不要な再レンダリング（フロントエンド）
- メモ化の不足
- バンドルサイズの増加（フロントエンド）
- データ取得の最適化不足
- データベースクエリの最適化不足（バックエンド）

#### アクセシビリティ関連

- ARIA属性の不足
- キーボードナビゲーションの対応不足
- スクリーンリーダー対応の不足
- カラーコントラストの問題

### 5. チェックリストの生成

検出した問題を優先度別に整理し、以下の形式でMarkdownファイルを生成します：

```markdown
# コードレビュー事前チェックリスト

## 🔴 重大な問題（修正必須）

### 1. [問題のタイトル]

**問題**: [具体的な問題の説明]
**影響**: [問題がもたらす影響]
**修正案**: [推奨される修正方法]
**該当ファイル**: [ファイルパス:行番号]

## 🟡 中程度の問題（修正推奨）

[...]

## 🟢 軽微な問題（改善推奨）

[...]

## テスト関連

[...]

## ドキュメント関連

[...]

## セキュリティ関連

[...]

## パフォーマンス関連

[...]

## アクセシビリティ関連

[...]

## チェックリスト

レビュー前に以下を確認：

- [ ] [チェック項目1]
- [ ] [チェック項目2]

## 優先度別修正推奨順

1. **最優先**: [重大な問題]
2. **高**: [中程度の問題]
3. **中**: [軽微な問題]
```

## 出力ファイル

チェックリストは `docs/code-review-yyyy-mm-dd_hh-mm.md` 形式で保存します。

## ルール

- 実装の詳細よりも、問題の本質と影響を重視
- 既存のコードベースパターンを尊重し、一貫性を優先
- 検出した問題には具体的なファイルパスと行番号を記載
- 修正案は実装可能で具体的な内容にする
- 言語・フレームワーク固有の記述は避け、一般的な概念で説明
- バックエンド・フロントエンド両方の観点を含める

